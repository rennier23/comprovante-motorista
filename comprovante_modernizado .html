<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comprovante do Motorista (MVP Local)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Font Awesome para ícones modernos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--pri:#0b6efd;--bg:#f6f7fb;--card:#fff;--bd:#e6e8ef;--success:#10b981;--warning:#f59e0b}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg)}
    header{padding:14px 16px;background:#fff;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:5;display:flex;gap:10px;align-items:center}
    header h1{font-size:18px;margin:0 8px 0 0}
    nav button{border:1px solid var(--bd);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--pri);color:#fff;border-color:var(--pri)}
    main{max-width:1050px;margin:18px auto;padding:0 16px 56px}
    .grid{display:grid;gap:14px}.card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1 1 220px}
    label{font-size:12px;font-weight:600;display:block;margin:10px 0 6px}
    input,select{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--pri);background:var(--pri);color:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:8px;text-decoration:none;font-size:14px;transition:all 0.2s ease}
    .btn.compact{padding:8px 12px;font-size:13px}
    .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(11,110,253,0.3)}
    .btn.secondary{background:#fff;color:#111;border-color:var(--bd)}
    .btn.secondary:hover{background:#f8f9fa;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    
    /* Estilos para os botões de upload */
    .upload-container{display:flex;gap:10px;flex-wrap:wrap}
    .upload-btn{flex:1;min-width:140px;justify-content:center;position:relative;overflow:hidden}
    .upload-btn input[type="file"]{position:absolute;left:-9999px;opacity:0}
    .upload-btn.success{background:var(--success);border-color:var(--success)}
    .upload-btn.success:hover{box-shadow:0 4px 12px rgba(16,185,129,0.3)}
    
    /* Preview da imagem */
    .image-preview{margin-top:10px;display:none}
    .image-preview img{max-width:200px;max-height:150px;border-radius:8px;border:1px solid var(--bd)}
    .image-preview .remove-btn{margin-left:10px;background:#ef4444;border-color:#ef4444;padding:6px 10px;font-size:12px}
    
    table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--bd);padding:8px 6px;text-align:left;font-size:14px}
    th{font-size:12px;color:#555}.muted{color:#666;font-size:12px}.tot{font-weight:700}
    .thumb{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--bd)}
    
    /* Responsividade para mobile */
    @media (max-width: 768px) {
      .upload-container{flex-direction:column}
      .upload-btn{min-width:100%}
      .row{flex-direction:column}
      .row>*{flex:1 1 auto}
    }
  </style>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://iazdknwffvdjxncsvvls.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhemRrbndmZnZkanhuY3N2dmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODYyNDksImV4cCI6MjA3MTQ2MjI0OX0.lBjj_IywnMKauk4rvCE3Tdb2S6X3sLJd-A44XgJSPYw";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET = "comprovantes";
  </script>

</head>
<body>
<header>
  <h1><i class="fas fa-truck"></i> Comprovante do Motorista</h1>
  <nav>
    <button data-tab="tab-registro" class="active"><i class="fas fa-plus"></i> Registrar</button>
    <button data-tab="tab-registros"><i class="fas fa-list"></i> Registros</button>
    <button data-tab="tab-dash"><i class="fas fa-chart-bar"></i> Dashboard</button>
  </nav>
</header>

<main>
  <!-- REGISTRAR -->
  <section id="tab-registro" class="grid">
    <div class="card">
      <h2><i class="fas fa-file-plus"></i> Novo comprovante</h2>
      <div class="row">
        <div><label><i class="fas fa-building"></i> Cliente</label><input id="cliente" placeholder="Ex.: SAPORE" required></div>
        <div><label><i class="fas fa-calendar"></i> Data</label><input id="data" type="date" required></div>
      </div>
      <div class="row">
        <div><label><i class="fas fa-user"></i> Motorista</label><input id="motorista" required></div>
        <div><label><i class="fas fa-car"></i> Placa</label><input id="placa" required></div>
        <div><label><i class="fas fa-boxes"></i> QTDE (paletes)</label><input id="qtde" type="number" min="0" step="1" required></div>
      </div>
      <div class="row">
        <div><label><i class="fas fa-signature"></i> Assinatura/PCO (texto)</label><input id="assinatura" placeholder="Nome do PCO / observação"></div>
        <div>
          <label><i class="fas fa-camera"></i> Foto do comprovante</label>
          <div class="upload-container">
            <button type="button" class="btn upload-btn" id="btnCamera">
              <i class="fas fa-camera"></i>
              Tirar Foto
            </button>
            <button type="button" class="btn secondary upload-btn" id="btnUpload">
              <i class="fas fa-upload"></i>
              Escolher Arquivo
              <input type="file" id="foto" accept="image/*">
            </button>
          </div>
          <div class="image-preview" id="imagePreview">
            <img id="previewImg" src="" alt="Preview">
            <button type="button" class="btn remove-btn" id="btnRemove">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-start;gap:12px">
        <button class="btn compact" id="btnSalvar" style="flex:none;width:auto;min-width:100px">
          <i class="fas fa-save"></i>
          Salvar
        </button>
        <button class="btn secondary" id="btnLimpar" style="flex:none;width:auto;min-width:100px">
          <i class="fas fa-eraser"></i>
          Limpar
        </button>
      </div>
      <p id="msg" class="muted"></p>
    </div>
  </section>

  <!-- REGISTROS -->
  <section id="tab-registros" class="grid" style="display:none">
    <div class="card">
      <h2><i class="fas fa-list"></i> Registros</h2>
      <div class="row">
        <div><label><i class="fas fa-search"></i> Buscar</label><input id="busca" placeholder="cliente, motorista, placa…"></div>
        <div><label><i class="fas fa-calendar-alt"></i> Data inicial</label><input id="ini" type="date"></div>
        <div><label><i class="fas fa-calendar-alt"></i> Data final</label><input id="fim" type="date"></div>
        <div><label><i class="fas fa-building"></i> Cliente</label><input id="fCliente" placeholder="(opcional)"></div>
        <div style="align-self:end">
          <button class="btn" id="btnFiltrar">
            <i class="fas fa-filter"></i>
            Aplicar filtros
          </button>
        </div>
      </div>
      <table id="tbl">
        <thead><tr><th>Data</th><th>Cliente</th><th>Motorista</th><th>Placa</th><th>QTDE</th><th>Foto</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="4" class="tot">Total</td><td class="tot" id="totQtde">0</td><td></td></tr></tfoot>
      </table>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="tab-dash" class="grid" style="display:none">
    <div class="card">
      <h2><i class="fas fa-chart-bar"></i> Dashboard</h2>
      <div class="row">
        <div><label><i class="fas fa-calendar-alt"></i> Período (início)</label><input id="dIni" type="date"></div>
        <div><label><i class="fas fa-calendar-alt"></i> Período (fim)</label><input id="dFim" type="date"></div>
        <div><label><i class="fas fa-layer-group"></i> Agrupar por</label>
          <select id="agrup">
            <option value="cliente">Cliente</option>
            <option value="data">Dia</option>
            <option value="motorista">Motorista</option>
            <option value="placa">Placa</option>
          </select>
        </div>
        <div><label><i class="fas fa-building"></i> Cliente (opcional)</label><input id="dCliente" placeholder="Filtrar por cliente"></div>
        <div style="align-self:end">
          <button class="btn" id="btnDash">
            <i class="fas fa-sync-alt"></i>
            Atualizar
          </button>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <div class="muted"><i class="fas fa-boxes"></i> Total de paletes</div>
          <div style="font-size:28px;font-weight:800" id="kpiTotal">0</div>
        </div>
        <div class="card">
          <div class="muted"><i class="fas fa-list-ol"></i> Registros</div>
          <div style="font-size:28px;font-weight:800" id="kpiRegs">0</div>
        </div>
      </div>

      <canvas id="graf"></canvas>
      <table id="tblDash" style="margin-top:10px">
        <thead><tr><th>Grupo</th><th>Paletes</th></tr></thead><tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // ---------- Navegação ----------
  document.querySelectorAll('nav button').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('nav button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.querySelectorAll('main>section').forEach(s=>s.style.display='none');
      document.getElementById(b.dataset.tab).style.display='grid';
    }
  });

  // ---------- Utils ----------
  const LSKEY = 'comprovantes_local';
  const fmtData = s => s ? new Date(s).toLocaleDateString('pt-BR') : "";
  const hojeISO = new Date().toISOString().slice(0,10);
  ['data','ini','fim','dIni','dFim'].forEach(id=>document.getElementById(id).value=hojeISO);

  function getDB(){ return JSON.parse(localStorage.getItem(LSKEY)||'[]'); }
  function setDB(arr){ localStorage.setItem(LSKEY, JSON.stringify(arr)); }

  // Converte imagem para DataURL (e comprime)
  function fileToDataURL(file, maxW=1200, quality=0.8){
    return new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          const ratio = Math.min(1, maxW/img.width);
          const w = Math.round(img.width*ratio), h = Math.round(img.height*ratio);
          const cv=document.createElement('canvas'); cv.width=w; cv.height=h;
          const ctx=cv.getContext('2d'); ctx.drawImage(img,0,0,w,h);
          resolve(cv.toDataURL('image/jpeg', quality));
        };
        img.onerror=reject; img.src=reader.result;
      };
      reader.onerror=reject; reader.readAsDataURL(file);
    });
  }
  // Converte DataURL -> Blob
  async function dataUrlToBlob(dataUrl){
    const res = await fetch(dataUrl);
    return await res.blob();
  }

  // Upload da foto para o Supabase Storage e retorna URLs
  async function uploadFotoSupabase(file, dataISO, placa){
    const dataUrl = await fileToDataURL(file, 1280, 0.82);
    const blob = await dataUrlToBlob(dataUrl);
    const ts = Date.now();
    const safePlaca = (placa||'SEMPLACA').replace(/\W+/g,'').toUpperCase();
    const folder = dataISO || new Date().toISOString().slice(0,10);
    const path = `${folder}/${safePlaca}-${ts}.jpg`;
    const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, blob, { contentType: 'image/jpeg', upsert: false });
    if (upErr) throw upErr;
    const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
    return { foto_url: data.publicUrl, foto_path: path };
  }


  // ---------- Funcionalidade de Upload e Câmera ----------
  let selectedFile = null;
  
  // Botão para tirar foto (câmera)
  document.getElementById('btnCamera').onclick = () => {
    // Criar input temporário para captura de câmera
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // Usar câmera traseira no mobile
    
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFileSelection(file, 'camera');
      }
    };
    
    input.click();
  };
  
  // Botão para escolher arquivo
  document.getElementById('btnUpload').onclick = () => {
    document.getElementById('foto').click();
  };
  
  // Handler para seleção de arquivo
  document.getElementById('foto').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      handleFileSelection(file, 'upload');
    }
  };
  
  // Função para lidar com a seleção de arquivo
  async function handleFileSelection(file, source) {
    try {
      selectedFile = file;
      
      // Mostrar preview
      const preview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      
      const dataUrl = await fileToDataURL(file);
      previewImg.src = dataUrl;
      preview.style.display = 'block';
      
      // Atualizar visual dos botões
      const cameraBtn = document.getElementById('btnCamera');
      const uploadBtn = document.getElementById('btnUpload');
      
      if (source === 'camera') {
        cameraBtn.classList.add('success');
        cameraBtn.innerHTML = '<i class="fas fa-check"></i> Foto Capturada';
        uploadBtn.classList.remove('success');
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Escolher Arquivo';
      } else {
        uploadBtn.classList.add('success');
        uploadBtn.innerHTML = '<i class="fas fa-check"></i> Arquivo Selecionado';
        cameraBtn.classList.remove('success');
        cameraBtn.innerHTML = '<i class="fas fa-camera"></i> Tirar Foto';
      }
      
    } catch (error) {
      console.error('Erro ao processar arquivo:', error);
      document.getElementById('msg').textContent = 'Erro ao processar a imagem.';
    }
  }
  
  // Botão para remover imagem
  document.getElementById('btnRemove').onclick = () => {
    selectedFile = null;
    document.getElementById('foto').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    
    // Resetar botões
    const cameraBtn = document.getElementById('btnCamera');
    const uploadBtn = document.getElementById('btnUpload');
    
    cameraBtn.classList.remove('success');
    cameraBtn.innerHTML = '<i class="fas fa-camera"></i> Tirar Foto';
    uploadBtn.classList.remove('success');
    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Escolher Arquivo';
  };

  // ---------- Salvar ----------
  
document.getElementById('btnSalvar').onclick = async ()=>{
    const msg = document.getElementById('msg');
    msg.textContent = "Processando…";

    const cliente = document.getElementById('cliente').value.trim();
    const data = document.getElementById('data').value;
    const motorista = document.getElementById('motorista').value.trim();
    const placa = document.getElementById('placa').value.trim().toUpperCase();
    const qtde = parseInt(document.getElementById('qtde').value||"0",10);
    const assinatura = document.getElementById('assinatura').value.trim();

    if(!cliente || !data || !motorista || !placa || !(qtde>=0) || !selectedFile){
      msg.textContent = "Preencha todos os campos obrigatórios e selecione uma foto.";
      return;
    }

    try{
      const { foto_url, foto_path } = await uploadFotoSupabase(selectedFile, data, placa);
      const { error: dbErr } = await supabase.from('comprovantes').insert([{
        data, cliente, motorista, placa, qtde, assinatura, foto_url, foto_path
      }]);
      if (dbErr) throw dbErr;
      msg.textContent = "Registro salvo!";
      document.getElementById('btnLimpar').click();
      await carregarRegistros(); await carregarDash();
    }catch(e){
      console.error(e); msg.textContent = "Erro ao salvar. Veja o console.";
      alert('Erro ao salvar: ' + (e.message || e.statusText || e));
    }
  };
document.getElementById('btnLimpar').onclick = ()=>{
    ['cliente','data','motorista','placa','qtde','assinatura'].forEach(id=>{
      document.getElementById(id).value="";
    });
    document.getElementById('data').value = hojeISO;
    document.getElementById('msg').textContent="";
    
    // Limpar seleção de arquivo
    document.getElementById('btnRemove').click();
  };

  // ---------- Registros + Filtros ----------
  function aplicarFiltros(rows){
    const q = document.getElementById('busca').value.trim().toLowerCase();
    const ini = document.getElementById('ini').value;
    const fim = document.getElementById('fim').value;
    const fCliente = document.getElementById('fCliente').value.trim().toLowerCase();

    return rows.filter(r=>{
      if(ini && r.data < ini) return false;
      if(fim && r.data > fim) return false;
      if(fCliente && !r.cliente?.toLowerCase().includes(fCliente)) return false;
      if(q){
        const blob = `${r.cliente} ${r.motorista} ${r.placa}`.toLowerCase();
        if(!blob.includes(q)) return false;
      }
      return true;
    }).sort((a,b)=>b.data.localeCompare(a.data) || b.id-a.id);
  }

  
async function carregarRegistros(){
    const ini = document.getElementById('ini').value;
    const fim = document.getElementById('fim').value;
    const fCliente = document.getElementById('fCliente').value.trim();
    const q = document.getElementById('busca').value.trim().toLowerCase();

    let qy = supabase.from('comprovantes').select('*')
      .order('data', { ascending:false })
      .order('id', { ascending:false })
      .limit(1000);
    if (ini) qy = qy.gte('data', ini);
    if (fim) qy = qy.lte('data', fim);
    if (fCliente) qy = qy.ilike('cliente', `%${fCliente}%`);

    const { data, error } = await qy;
    if (error) { console.error(error); return; }

    const rows = q ? data.filter(r => (`${r.cliente} ${r.motorista} ${r.placa}`.toLowerCase().includes(q))) : data;

    const tb = document.querySelector('#tbl tbody'); tb.innerHTML="";
    let tot=0;
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtData(r.data)}</td>
        <td>${r.cliente||''}</td>
        <td>${r.motorista||''}</td>
        <td>${r.placa||''}</td>
        <td>${r.qtde||0}</td>
        <td>${r.foto_url?`<a href="${r.foto_url}" target="_blank"><img class="thumb" src="${r.foto_url}"></a>`:''}</td>`;
      tb.appendChild(tr); tot += (r.qtde||0);
    });
    document.getElementById('totQtde').textContent = tot;
  }
document.getElementById('btnFiltrar').onclick = carregarRegistros;

  // ---------- Dashboard ----------
  let chart;
  
let chart;
async function carregarDash(){
    const di = document.getElementById('dIni').value;
    const df = document.getElementById('dFim').value;
    const grp = document.getElementById('agrup').value;
    const fCli = document.getElementById('dCliente').value.trim();

    let qy = supabase.from('comprovantes').select('*');
    if (di) qy = qy.gte('data', di);
    if (df) qy = qy.lte('data', df);
    if (fCli) qy = qy.ilike('cliente', `%${fCli}%`);
    const { data: base, error } = await qy;
    if (error) { console.error(error); return; }

    const map = new Map();
    base.forEach(r=>{
      const key = grp==='data' ? r.data : (r[grp]||'(vazio)');
      map.set(key, (map.get(key)||0) + (r.qtde||0));
    });

    const labels = Array.from(map.keys()).sort((a,b)=> grp==='data'? a.localeCompare(b) : a.localeCompare(b,'pt-BR',{numeric:true}));
    const data = labels.map(k=>map.get(k));
    const soma = data.reduce((a,b)=>a+b,0);

    document.getElementById('kpiTotal').textContent = soma;
    document.getElementById('kpiRegs').textContent = base.length;

    const tb = document.querySelector('#tblDash tbody'); tb.innerHTML="";
    labels.forEach((l,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${grp==='data'?fmtData(l):l}</td><td>${data[i]}</td>`;
      tb.appendChild(tr);
    });

    const ctx = document.getElementById('graf');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type:'bar',
      data:{ labels: labels.map(x=> grp==='data'?fmtData(x):x), datasets:[{label:'Paletes', data}] },
      options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });
  }
// inicial
  carregarRegistros(); carregarDash();
  document.getElementById('btnDash').onclick = carregarDash;
</script>
</body>
</html>

